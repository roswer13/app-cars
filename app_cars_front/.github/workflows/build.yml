name: ðŸ”¨ðŸ§ª Build & Test

permissions: write-all

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref }}
  cancel-in-progress: true

on: [push]

jobs:
  testAndCoverage:
    name: ðŸ§ª Test
    uses: ./app_cars_front/.github/workflows/_test_with_coverage.yml
    secrets: inherit

  analyze:
    name: Analyze
    if: github.event.pull_request.draft == false
    timeout-minutes: 30
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v3

      - name: âš™ï¸ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: âš™ï¸ Flutter pub get
        run: flutter pub get

      - name: ðŸ“¡ Run flutter analyze
        run: |
          flutter analyze > analysis_output.txt || true

      - name: ðŸ“ˆ Check for code issues
        id: code-issues
        run: |
          if grep -q "error â€¢" analysis_output.txt; then
            echo "::error::Code analysis failed"
            exit 1
          else
            echo "Code analysis passed"
          fi

      - name: ðŸ“„ Upload analysis results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-results
          path: analysis_output.txt